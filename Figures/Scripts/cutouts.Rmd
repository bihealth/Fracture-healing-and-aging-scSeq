---
author: "Mireille Ngokingha Tchouto and Miha Milek"
output: 
  html_document:
    df_print: paged
    code_folding: hide
params:
  title: "Bone healing Fig 4"
  object: "Figures/data/HSC_pseudotime_correct.rds"
  git_path: "/mnt/d/work/mireille/fracture-healing-and-aging-scseq"
  figure_out_path: "/mnt/d/onedrive/OneDrive - Charité - Universitätsmedizin Berlin/Third version/Figures/redone/"
---

```{r setup, include=FALSE}
library(slingshot)
library(magrittr)
library(pheatmap)
library(tibble)
library(scater)
library(httr)
library(Seurat)
library(dplyr)
library(stringr)
library(ggplot2)
library(cowplot)
library(igraph)
library(Matrix)
library(tidyr)
library(tidyverse)
library(RCurl)
library(plyr)
library(DESeq2)
library(plyr)
library(gtools)
library(biomaRt)
library(AnnotationHub)
library(org.Hs.eg.db)
library(clusterProfiler)
library(org.Mm.eg.db)
library(SingleR)
library(tibble)
library(SingleCellExperiment)
library(scran)
library(apeglm)
library(ashr)
library(sctransform)
library(RColorBrewer)
library(BiocParallel)
library(extrafont)
library(Rttf2pt1) # v1.3.8 or lower
# font_import(paths="/mnt/c/Windows/Fonts", pattern="arial", prompt=F)
loadfonts(device = "all")
library(patchwork)
library(magick)
library(ggpubr)
```

```{r paths}

git_path <- params$git_path

figure_out_path <- params$figure_out_path

dir.create(figure_out_path, showWarnings = F, recursive = T)

``` 

Figure 4.
Data input. This is the final object after the slingshot analysis. For documentation of Slingshot analysis, look at Scripts/slingshot.Rmd

```{r input, fig.width = 10, fig.height = 5}

sub <- readRDS(file.path(git_path, params$object))


```


Rename HPC cluster.
```{r rename}

Idents(sub)<-sub$seurat_clusters
new.cluster.ids <- c( "Immature B Cells", "Mature B Cells", "HPCs", "Immature B Cells",
                      "HPCs","HPCs", "Pre / Pro B Cells", "HPCs", "Pre / Pro B Cells")
names(new.cluster.ids) <- levels(sub)
sub <- RenameIdents(sub, new.cluster.ids)
sub$CellType<-Idents(sub)
```

Dotplot figure 4.

```{r dotplot, fig.width = 8/3, fig.height = 3}
features <- c("Cd34","Kit","Flt3","Vpreb1","Igll1","Tnfrsf13c","Cd38","Ly6a","Fcer2a")

sub$CellType<- factor(sub$CellType, levels = c("HPCs","Pre / Pro B Cells", "Immature B Cells", "Mature B Cells"))
Idents(sub)<-sub$CellType


```

boxplot pseudotime figure 3
```{r ps7,fig.height=3,fig.width=8/3}

my_comparisons <- list(c("2days", "5days"))

ps7<- sub[[]] %>%
  subset(compartments == "Hematoma") %>%
  subset(Age_raw == "ImmunoAged") %>%
  select(sample,Age_raw,pseudotime_lin1,compartments,timepoint) %>% 
  mutate(timepoint=factor(timepoint, levels=c("2days","5days")))%>%
  ggplot(aes(timepoint, pseudotime_lin1))+ 
  geom_boxplot(size = .4, outlier.size = 0) + 
  geom_point(aes(color = timepoint), position=position_jitterdodge(jitter.width = .2), shape = 1,size = .6) +
  coord_cartesian(ylim=c(0,40))+
  stat_compare_means(comparisons = my_comparisons,label="p.signif",
                     method = "wilcox.test",label.y = 36, hide.ns = TRUE) + theme_classic() + 
  theme(axis.title = element_text(size = 8), 
        axis.text = element_text(size = 8, family = "Arial"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.text = element_text(size=8),
        legend.title=element_text(size=8),
        strip.text.x = element_text(size = 8),
        strip.text.y = element_text(size = 8),
        plot.title = element_text(size = 8,face="bold",hjust = 0.5,))+
  scale_color_manual(name= "Time",values = c("dodgerblue3","orange2")) + 
  labs(title ="Immune-aged, hematoma", x = c(), y = 'Pseudotime') 

ps7

```
boxplot From HSCS to Pre/Pro B cells
```{r ps8,fig.height=3,fig.width=8/3}
my_comparisons <- list(c("2days", "5days"))
ps8<- sub[[]] %>%
  subset(compartments == "Hematoma") %>%
  subset(Age_raw == "ImmunoAged") %>%
  filter(CellType %in% c("HPCs","Pre / Pro B Cells")) %>% 
  select(sample,Age_raw,pseudotime_lin1,compartments,CellType,timepoint) %>% 
  mutate(Age_raw=factor(Age_raw, levels = c("Young", "Aged","ImmunoAged"))) %>%
  ggplot(aes(timepoint, pseudotime_lin1))+ 
  geom_boxplot(size = .4, outlier.size = 0) + 
  geom_point(aes(color = timepoint), position=position_jitterdodge(jitter.width = .2), shape = 1,size = .6) +
  coord_cartesian(ylim=c(0,40))+
  stat_compare_means(comparisons = my_comparisons,label="p.signif",
                     method = "wilcox.test",label.y = 35, label.x = "5days" , hide.ns = TRUE) + theme_classic() + 
  theme(axis.title = element_text(size = 8), 
        axis.text = element_text(size = 8, family = "Arial"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.text = element_text(size =8),
        strip.text.x = element_text(size = 8),
        strip.text.y = element_text(size = 8),
        plot.title = element_text(size = 8,face="bold",hjust = 0.5,),
        legend.position = "none")+
  scale_color_manual(name= "Time",values = c("dodgerblue3","orange2")) + 
  labs(title ="Immune-aged (hematoma): \nfrom HSCS to Pre / Pro B cells", x = c(color =''), y = 'Pseudotime') 

ps8

```

boxplot From Pre / Pro B Cells to immature B cells
```{r ps9,fig.height=3,fig.width=8/3}
my_comparisons <- list(c("2days", "5days"))

ps9<- sub[[]] %>%
  subset(compartments == "Hematoma") %>%
  subset(Age_raw == "ImmunoAged") %>%
  filter(CellType %in% c("Pre / Pro B Cells","Immature B Cells")) %>% 
  select(sample,Age_raw,pseudotime_lin1,compartments,CellType,timepoint) %>% 
  mutate(Age_raw=factor(Age_raw, levels = c("Young", "Aged","ImmunoAged"))) %>%
  ggplot(aes(timepoint, pseudotime_lin1))+ 
  geom_boxplot(size = .4, outlier.size = 0) + 
  geom_point(aes(color = timepoint), position=position_jitterdodge(jitter.width = .2), shape = 1,size = .6) +
  coord_cartesian(ylim=c(0,40))+
  stat_compare_means(comparisons = my_comparisons,label="p.signif",
                     method = "wilcox.test",label.y = 35, label.x = "5days" , hide.ns = TRUE) + theme_classic() + 
  theme(axis.title = element_text(size = 8), 
        axis.text = element_text(size = 8, family = "Arial"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        #strip.background = element_blank(),
        legend.text = element_text(size =8),
        strip.text.x = element_text(size = 8),
        strip.text.y = element_text(size = 8),
        plot.title = element_text(size = 8,face="bold",hjust = 0.5,),
        legend.position = "none")+
  scale_color_manual(name= "Time",values = c("dodgerblue3","orange2")) + 
  labs(title ="Immune-aged (hematoma): \nfrom Pre / Pro B cells to \nimmature B cells", x = c(color =''), y = 'Pseudotime') 

ps9

```
boxplot from immature b cells to mature b cells
```{r ps10,fig.height=8/3,fig.width=3}

my_comparisons <- list(c("2days", "5days"))

ps10 <- sub[[]] %>%
  subset(compartments == "Hematoma") %>%
  subset(Age_raw == "ImmunoAged") %>%
  filter(CellType %in% c("Immature B Cells","Mature B Cells")) %>% 
  select(sample,Age_raw,pseudotime_lin1,compartments,CellType,timepoint) %>% 
  mutate(Age_raw=factor(Age_raw, levels = c("Young", "Aged","ImmunoAged"))) %>%
  ggplot(aes(timepoint, pseudotime_lin1))+ 
  geom_boxplot(size = .4, outlier.size = 0) + 
  geom_point(aes(color = timepoint), position=position_jitterdodge(jitter.width = .2), shape = 1,size = .6) +
  coord_cartesian(ylim=c(0,40))+
  stat_compare_means(comparisons = my_comparisons,label="p.signif",
                     method = "wilcox.test",label.y = 38, hide.ns = TRUE) + theme_classic() + 
  theme(axis.title = element_text(size = 8), 
        axis.text = element_text(size = 8, family = "Arial"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.title = element_text(size=8),
        legend.text = element_text(size =8),
        strip.text.x = element_text(size = 8),
        strip.text.y = element_text(size = 8),
        plot.title = element_text(size = 8,face="bold",hjust = 0.5,))+
  scale_color_manual(name= "Time",values = c("dodgerblue3","orange2")) + 
  labs(title ="Immune-aged (hematoma): \nfrom immature B cells to \nmature B cells", x = c(color =''), y = 'Pseudotime') 

ps10
```

```{r ma100, fig.width=9,fig.height=9}
# for (comparison in unique(res_df$contrast)){
#   p <- res_df %>%
#     dplyr::filter(contrast == comparison) %>%
#     ggplot(aes(x=baseMean,y=log2FoldChange,color=padj < .05)) +
#     geom_point(size=.5, shape=1) +
#     geom_label_repel(data=res_df %>%
#                        dplyr::filter(contrast == comparison, padj < .05),
#                      aes(label=gene_name),
#                      segment.size=.25,segment.alpha=.5,size=3,color='black',max.overlaps=30,
#                      label.padding=0.05,label.size=NA) +
#     scale_color_manual(values=c('black','red')) +
#     scale_x_continuous(trans='log10') +
#     coord_cartesian(ylim =c(-4,4)) +
#     theme_classic() +
#     theme(legend.position='none',
#           strip.background=element_blank())+
#     ggtitle(comparison)+
#     facet_wrap(~cell_type, ncol = 2)
#   print(p)
# }
```

```{r run tmod, fig.width=22,fig.height=18}

res <- split(res_df, f = res_df$contrast)
genes <- lapply(res, function(x) x %>%
                  filter(!is.na(padj)) %>%
                  arrange(pvalue))
genes_reduced <- genes[c(3, 8, 14)]
lgenes <- lapply(genes_reduced, function(x) x$gene_name)

res.tmod <- lapply(lgenes, tmodCERNOtest, mset = msig[sel])

res.tmod.filtered <- lapply(res.tmod, function(x) subset(x, adj.P.Val < 1e-5 & AUC > .75))

pie <- lapply(genes_reduced, function(x) tmodDecideTests(x$gene_name, lfc = x$log2FoldChange,
                                                 pval = x$padj, lfc.thr=0.5,pval.thr=0.1, mset = msig[sel]))
pie <- lapply(pie, as.data.frame)

tmodPanelPlot(res.tmod.filtered, text.cex = 1.0, pie = pie, pie.style="rug", grid="at")
```





```{r plot ifn, fig.width=8,fig.height=6}

library(ggpubr)
my_comparisons <- list(c("2days", "5days"))

sobj[[]] %>%
  select(strain, compartments, CellTypes, IfnResponse1, timepoint ) %>%
  filter(compartments=="Hematoma" & strain =="Immune-aged") %>%
  filter(!is.na(IfnResponse1)) %>%
  ggplot(aes(timepoint, IfnResponse1, colour=timepoint))+
  geom_boxplot(fill="white",outlier.shape = NA)+
  geom_point(shape=1,position = position_jitterdodge(jitter.width = .3),size=1)+
  coord_cartesian(ylim=c(-0.25,1.2))+
  facet_wrap(~CellTypes, scales="free_x")+
  stat_compare_means(comparisons = my_comparisons, label="p.signif",
                     method = "wilcox.test",label.y = .8, hide.ns = FALSE,size=3.5) +
  scale_colour_manual(values=c("dodgerblue3","orange3"))+
  ylab("Gene module score Ifn response")+
  theme(axis.text.x=element_blank())+
  labs(x=c())

```

```{r plot b cells}
 
sobj[[]] %>%
  select(strain, compartments, CellTypes, B_cell_genes1,timepoint ) %>%
  filter(compartments=="Hematoma" & strain =="Immune-aged") %>%
  filter(!is.na(B_cell_genes1)) %>%
  ggplot(aes(timepoint, B_cell_genes1, colour=timepoint))+
  geom_boxplot(fill="white",outlier.shape = NA)+
  geom_point(shape=1,position = position_jitterdodge(jitter.width = .3),size=1)+
  coord_cartesian(ylim=c(-0.25,1.6))+
  facet_wrap(~CellTypes, scales="free_x")+
  stat_compare_means(comparisons = my_comparisons, label="p.signif",
                     method = "wilcox.test",label.y = 1.3, hide.ns = FALSE,size=3.5) +
  scale_colour_manual(values=c("dodgerblue3","orange3"))+
  ylab("Gene module score B cell genes")+
  theme(axis.text.x=element_blank())+
  labs(x=c())

```




```{r plot ifn 2, fig.width=8,fig.height=6}

library(ggpubr)
my_comparisons <- list(c("2days", "5days"))

sobj[[]] %>%
  select(strain, compartments, CellTypes, Interferon_gene_set1, timepoint ) %>%
  filter(compartments=="Hematoma" & strain =="Immune-aged") %>%
  filter(!is.na(Interferon_gene_set1)) %>%
  ggplot(aes(timepoint, Interferon_gene_set1, colour=timepoint))+
  geom_boxplot(outlier.shape = NA)+
  # geom_violin()+
  geom_point(shape=1,position = position_jitterdodge(jitter.width = .3),size=1)+
  coord_cartesian(ylim=c(-0.25,1.2))+
  facet_wrap(~CellTypes, scales="free_x")+
  stat_compare_means(comparisons = my_comparisons, label="p.signif",
                     method = "wilcox.test",label.y = .8, hide.ns = FALSE,size=3.5) +
  scale_colour_manual(values=c("dodgerblue3","orange3"))+
  ylab("Gene module score Interferon")+
  theme(axis.text.x=element_blank())+
  labs(x=c())

```

```{r plot ifn 2, fig.width=8,fig.height=6}

library(ggpubr)
my_comparisons <- list(c("2days", "5days"))

sobj[[]] %>%
  select(strain, compartments, CellTypes, Interferon_gene_set1, timepoint ) %>%
  mutate(strain=factor(strain, levels=c("Young","Aged","Immune-aged"))) %>%
  filter(CellTypes %in% c("Monocytes")) %>%
  filter(!is.na(Interferon_gene_set1)) %>%
  ggplot(aes(timepoint, Interferon_gene_set1, colour=timepoint))+
  geom_boxplot(outlier.shape = NA)+
  # geom_violin()+
  geom_point(shape=1,position = position_jitterdodge(jitter.width = .3),size=1)+
  coord_cartesian(ylim=c(-0.25,1.2))+
  facet_wrap(~CellTypes+compartments+strain, scales="free_x",ncol=6)+
  stat_compare_means(comparisons = my_comparisons, label="p.signif",
                     method = "wilcox.test",label.y = .8, hide.ns = FALSE,size=3.5) +
  scale_colour_manual(values=c("dodgerblue3","orange3"))+
  ylab("Gene module score Interferon")+
  theme(axis.text.x=element_blank())+
  labs(x=c())


sobj[[]] %>%
  select(strain, compartments, CellTypes, B_cell_genes1 , timepoint ) %>%
  mutate(strain=factor(strain, levels=c("Young","Aged","Immune-aged"))) %>%
  filter(CellTypes %in% c("B Cells")) %>%
  filter(!is.na(B_cell_genes1 )) %>%
  ggplot(aes(timepoint, B_cell_genes1 , colour=timepoint))+
  geom_boxplot(outlier.shape = NA)+
  # geom_violin()+
  geom_point(shape=1,position = position_jitterdodge(jitter.width = .3),size=1)+
  coord_cartesian(ylim=c(-0.25,1.2))+
  facet_wrap(~CellTypes+compartments+strain, scales="free_x",ncol=6)+
  stat_compare_means(comparisons = my_comparisons, label="p.signif",
                     method = "wilcox.test",label.y = .8, hide.ns = FALSE,size=3.5) +
  scale_colour_manual(values=c("dodgerblue3","orange3"))+
  ylab("Gene module score Interferon")+
  theme(axis.text.x=element_blank())+
  labs(x=c())
```




```{r s}
p1 <- sobj %>%
  subset(CellTypes=="B Cells" & compartments=="Hematoma") %>%
VlnPlot(features = c("Il7r"), stack=F, flip=F, group.by=c("strain"), split.by="timepoint")+
  ggtitle("Hematoma")


p2 <- sobj %>%
  subset(CellTypes=="B Cells" & compartments=="Dist") %>%
VlnPlot(features = c("Il7r"), stack=F, flip=F, group.by=c("strain"), split.by="timepoint")+
  ggtitle("Distal")

p3 <- sobj %>%
  subset(CellTypes=="B Cells" & compartments=="Prox") %>%
VlnPlot(features = c("Il7r"), stack=F, flip=F, group.by=c("strain","compartments"), split.by="timepoint")+
  ggtitle("Proximal")

(p1+p2+p3)+
  plot_layout(guides="collect") &
  theme(legend.position = "bottom",plot.tag = element_text(size = 8,face = "bold",hjust = -.5, vjust = 0))
```

```{r plot ifn 2, fig.width=8,fig.height=6}

library(ggpubr)
my_comparisons <- list(c("2days", "5days"))

sobj[[]] %>%
  select(strain, compartments, CellTypes, Interferon_gene_set1, timepoint ) %>%
  filter(compartments=="Prox" & strain =="Immune-aged") %>%
  filter(!is.na(Interferon_gene_set1)) %>%
  ggplot(aes(timepoint, Interferon_gene_set1, colour=timepoint))+
  geom_boxplot(outlier.shape = NA)+
  # geom_violin()+
  geom_point(shape=1,position = position_jitterdodge(jitter.width = .3),size=1)+
  coord_cartesian(ylim=c(-0.25,1.2))+
  facet_wrap(~CellTypes, scales="free_x")+
  stat_compare_means(comparisons = my_comparisons, label="p.signif",
                     method = "wilcox.test",label.y = .8, hide.ns = FALSE,size=3.5) +
  scale_colour_manual(values=c("dodgerblue3","orange3"))+
  ylab("Gene module score Interferon")+
  theme(axis.text.x=element_blank())+
  labs(x=c())

```

```{r interferon 5, fig.width = 8/2, fig.height = 3}
################################# 5 days ############################################
Idents(Downsample)<-Downsample$timepoint
testdata <-subset(Downsample, idents = c("5days"))
Idents(testdata)<-testdata$compartments
test <-subset(testdata, idents = c("Hematoma"))
Idents(test)<-test$Age_raw
Immunoaged <- subset(test, idents = c("Immunoaged"))
Idents(Immunoaged)<-Immunoaged$CellTypes
# Plot module scores bcells 5 days
p14<-FeaturePlot(Immunoaged,
                 features = "IfnResponse1",label = FALSE, repel = TRUE) +
  scale_colour_gradientn(colours = rev(brewer.pal(n = 11, name = "RdBu")), limits = c(0.0, 1.5)) +
  guides(colour=guide_colorbar(title="Gene module \nscore"))+
  theme(text = element_text(family = "Arial"),
        plot.title = element_text(size = 8),
        axis.title = element_text(size = 8),
        axis.text = element_text(size = 8),
        legend.text = element_text(size =8),
        legend.title = element_text(size = 8),
        strip.text.x = element_text(size = 8),
        legend.position = "top",
        legend.justification = "center") + labs(title = "Immune-aged: hematoma, 5 days")  & NoAxes()

p14
```


Generating Figure 4 D
```{r f4d,fig.height=3,fig.width=8/2}

library(ggpubr)
my_comparisons <- list(c("2days", "5days"))
DefaultAssay(Downsample) <- "RNA"
p15<-Downsample[[]] %>%
  subset(compartments == "Hematoma") %>%
  subset(Age_raw=="Immunoaged") %>%
  filter(CellTypes %in% c("B Cells")) %>% 
  select(sample,group, Age_raw,Genes_Bcells1,compartments,timepoint,CellTypes) %>% 
   #mutate(Age_raw=factor(Age_raw, levels = c("Young","Aged","ImmunoAged"))) %>%
  ggplot(aes(timepoint, Genes_Bcells1))+ 
  geom_boxplot(size = .4, outlier.size = 0) + 
  geom_point(aes(color = timepoint), size = .6) +
   #facet_wrap(~Age_raw, scales="free_x")+   
  ylim(0, 2) + 
  stat_compare_means(comparisons = my_comparisons,label="p.signif",
                  method = "t.test",label.y = 1.5, label.x = "5days",size = 6.1167,hide.ns = FALSE) + theme_classic() + 
theme(axis.title = element_text(size = 8), 
        axis.text = element_text(size = 8, family = "Arial"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        axis.text.y=element_text(size =8),
        legend.text = element_text(size =8),
        legend.title = element_text(size =8),
        strip.text.x = element_text(size = 8),
        strip.text.y = element_text(size = 8),
        plot.title = element_text(size =8,hjust = 0.5,))+
     scale_color_manual(name= "Time",values = c("dodgerblue3","orange2")) + labs(title ="Immune-aged: hematoma", x = c(color =''), y = 'Gene module score of LI.M47.0') 
p15
```{r sessionInfo}
sessionInfo()
```

