---
author: "Mireille Ngokingha Tchouto and Miha Milek"
output: 
  html_document:
    df_print: paged
    code_folding: hide
params:
  title: "Bone healing SFig 4"
  object: "Figures/data/HSC_pseudotime_correct.rds"
  git_path: "/mnt/d/work/mireille/fracture-healing-and-aging-scseq"
  figure_out_path: "/mnt/d/onedrive/OneDrive - Charité - Universitätsmedizin Berlin/Third version/Figures/redone/"
---

```{r setup, include=FALSE}
library(slingshot)
library(magrittr)
library(pheatmap)
library(tibble)
library(scater)
library(httr)
library(Seurat)
library(dplyr)
library(stringr)
library(ggplot2)
library(cowplot)
library(igraph)
library(Matrix)
library(tidyr)
library(tidyverse)
library(RCurl)
library(plyr)
library(DESeq2)
library(plyr)
library(gtools)
library(biomaRt)
library(AnnotationHub)
library(org.Hs.eg.db)
library(clusterProfiler)
library(org.Mm.eg.db)
library(SingleR)
library(tibble)
library(SingleCellExperiment)
library(scran)
library(apeglm)
library(ashr)
library(sctransform)
library(RColorBrewer)
library(BiocParallel)
library(extrafont)
library(Rttf2pt1) # v1.3.8 or lower
# font_import(paths="/mnt/c/Windows/Fonts", pattern="arial", prompt=F)
loadfonts(device = "all")
library(patchwork)
library(magick)
library(ggpubr)
```

```{r paths}

git_path <- params$git_path

figure_out_path <- params$figure_out_path

dir.create(figure_out_path, showWarnings = F, recursive = T)

``` 

Figure 4.
Data input. This is the final object after the slingshot analysis. For documentation of Slingshot analysis, look at Scripts/slingshot.Rmd

```{r input, fig.width = 10, fig.height = 5}

sub <- readRDS(file.path(git_path, params$object))


```


Rename HPC cluster.
```{r rename}

Idents(sub)<-sub$seurat_clusters
new.cluster.ids <- c( "Immature B Cells", "Mature B Cells", "HPCs", "Immature B Cells",
                      "HPCs","HPCs", "Pre / Pro B Cells", "HPCs", "Pre / Pro B Cells")
names(new.cluster.ids) <- levels(sub)
sub <- RenameIdents(sub, new.cluster.ids)
sub$CellType<-Idents(sub)
```

Factorize CellType ident.

```{r dotplot, fig.width = 8/3, fig.height = 3}

sub$CellType<- factor(sub$CellType, levels = c("HPCs","Pre / Pro B Cells", "Immature B Cells", "Mature B Cells"))
Idents(sub)<-sub$CellType

```


generating Supplemental figure 3

boxplot all mouse groups, from HSCs to mature B cells (slingshot)
```{r sf41,fig.height=3,fig.width=8/2}

my_comparisons <- list(c("2days", "5days"))

labs <- c("Young"="Young",
          "Aged"="Aged",
          "ImmunoAged"="Immune-\naged")

SF4_1<- sub[[]] %>%
  subset(compartments == "Prox") %>%
  select(sample,Age_raw,pseudotime_lin1,compartments,timepoint) %>% 
  mutate(Age_raw=factor(Age_raw, levels = c("Young", "Aged","ImmunoAged"))) %>%
  ggplot(aes(timepoint, pseudotime_lin1))+ 
  geom_boxplot(size = .4, outlier.size = 0) + 
  geom_point(aes(color = timepoint),position=position_jitterdodge(jitter.width = .2), shape = 1,size = .6) +
  facet_wrap(~Age_raw, scales="free_x",labeller = as_labeller(labs))+
  coord_cartesian(ylim=c(0,42))+
  stat_compare_means(comparisons = my_comparisons,label="p.signif",
                     method = "wilcox.test",label.y = 37, hide.ns = TRUE) +
  theme(axis.title = element_text(size = 8), 
        axis.text = element_text(size = 8, family = "Arial"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.text = element_text(size =8),
        legend.position = "top",
        legend.title=element_text(size=8),
        strip.text.x = element_text(size = 8),
        strip.text.y = element_text(size = 8),
        plot.title = element_text(size = 8,face="bold",hjust = 0.5,))+
  scale_color_manual(name= "Time",values = c("dodgerblue3","orange2")) + 
  labs(title ="Pseudotime proximal (slingshot)", x = c(color =''), y = 'Pseudotime') 

SF4_1
```


```{r sf42,fig.height=3,fig.width=8/2}

my_comparisons <- list(c("2days", "5days"))

labs <- c("Young"="Young",
          "Aged"="Aged",
          "ImmunoAged"="Immune-\naged")

SF4_2<- sub[[]] %>%
  subset(compartments == "Dist") %>%
  select(sample,Age_raw,pseudotime_lin1,compartments,timepoint) %>% 
  mutate(Age_raw=factor(Age_raw, levels = c("Young", "Aged","ImmunoAged"))) %>%
  ggplot(aes(timepoint, pseudotime_lin1))+ 
  geom_boxplot(size = .4, outlier.size = 0) + 
  geom_point(aes(color = timepoint),position=position_jitterdodge(jitter.width = .2), shape = 1,size = .6) +
  facet_wrap(~Age_raw, scales="free_x",labeller = as_labeller(labs))+
  coord_cartesian(ylim=c(0,42))+
  stat_compare_means(comparisons = my_comparisons,label="p.signif",
                     method = "wilcox.test",label.y = 37, hide.ns = TRUE) +
  theme(axis.title = element_text(size = 8), 
        axis.text = element_text(size = 8, family = "Arial"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.text = element_text(size =8),
        legend.position = "top",
        legend.title=element_text(size=8),
        strip.text.x = element_text(size = 8),
        strip.text.y = element_text(size = 8),
        plot.title = element_text(size = 8,face="bold",hjust = 0.5,))+
  scale_color_manual(name= "Time",values = c("dodgerblue3","orange2")) + 
  labs(title ="Pseudotime distal (slingshot)", x = c(color =''), y = 'Pseudotime') 

SF4_2
```





From Hscs to Pre/pro
```{r sf43,fig.height=3,fig.width=8/2}

my_comparisons <- list(c("2days", "5days"))

SF4_3<- sub[[]] %>%
  subset(compartments == "Prox") %>%
  filter(CellType %in% c("HPCs","Pre / Pro B Cells" )) %>% 
  select(sample,Age_raw,pseudotime_lin1,compartments,CellType,timepoint) %>% 
  mutate(Age_raw=factor(Age_raw, levels = c("Young", "Aged","ImmunoAged"))) %>%
  ggplot(aes(timepoint, pseudotime_lin1))+ 
  geom_boxplot(size = .4, outlier.size = 0) + 
  geom_point(aes(color = timepoint), position=position_jitterdodge(jitter.width = .2), shape = 1,size = .6) +
  coord_cartesian(ylim=c(0,40))+
  facet_wrap(~Age_raw, scales="free_x",labeller=as_labeller(labs))+
  stat_compare_means(comparisons = my_comparisons,label="p.signif",
                     method = "wilcox.test",label.y = 35, label.x = "5days" , hide.ns = TRUE) +
  theme(axis.title = element_text(size = 8), 
        axis.text = element_text(size = 8, family = "Arial"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position="top",
        legend.title=element_text(size=8),
        legend.text = element_text(size =8),
        strip.text.x = element_text(size = 8),
        strip.text.y = element_text(size = 8),
        plot.title = element_text(size = 8,face="bold",hjust = 0.5,))+
  scale_color_manual(name= "Time",values = c("dodgerblue3","orange2")) + 
  labs(title ="Pseudotime proximal from HSCS \nto Pre / Pro B cells", x = c(color =''), y = 'Pseudotime') 

SF4_3
```

From Pre/pro B cells to immature B cells
```{r sf44,fig.height=3,fig.width=8/2}

my_comparisons <- list(c("2days", "5days"))

SF4_4<- sub[[]] %>%
  subset(compartments == "Prox") %>%
  filter(CellType %in% c("Pre / Pro B Cells","Immature B Cells")) %>% 
  select(sample,Age_raw,pseudotime_lin1,compartments,CellType,timepoint) %>% 
  mutate(Age_raw=factor(Age_raw, levels = c("Young", "Aged","ImmunoAged"))) %>%
  ggplot(aes(timepoint, pseudotime_lin1))+ 
  geom_boxplot(size = .4, outlier.size = 0) + 
  geom_point(aes(color = timepoint), position=position_jitterdodge(jitter.width = .2), shape = 1,size = .6) +
  coord_cartesian(ylim=c(0,40))+
  facet_wrap(~Age_raw, scales="free_x", labeller=as_labeller(labs))+
  stat_compare_means(comparisons = my_comparisons,label="p.signif",
                     method = "wilcox.test",label.y = 35, label.x = "5days" , hide.ns = TRUE,) +
  theme(axis.title = element_text(size = 8), 
        axis.text = element_text(size = 8, family = "Arial"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position="top",
        legend.title = element_text(size=8),
        legend.text = element_text(size =8),
        strip.text.x = element_text(size = 8),
        strip.text.y = element_text(size = 8),
        plot.title = element_text(size = 8,face="bold",hjust = 0.5,))+
  scale_color_manual(name= "Time",values = c("dodgerblue3","orange2")) + 
  labs(title ="Pseudotime proximal from Pre / Pro B cells \nto immature B cells", x = c(color =''), y = 'Pseudotime') 

SF4_4

```

From immature B cells to mature B cells
```{r sf45,fig.height=3,fig.width=8/2}
my_comparisons <- list(c("2days", "5days"))


SF4_5<- sub[[]] %>%
  subset(compartments == "Dist") %>%
  filter(CellType %in% c("Immature B Cells","Mature B Cells")) %>% 
  select(sample,Age_raw,pseudotime_lin1,compartments,CellType,timepoint) %>% 
  mutate(Age_raw=factor(Age_raw, levels = c("Young", "Aged","ImmunoAged"))) %>%
  ggplot(aes(timepoint, pseudotime_lin1))+ 
  geom_boxplot(size = .4, outlier.size = 0) + 
  geom_point(aes(color = timepoint), position=position_jitterdodge(jitter.width = .2), shape = 1,size = .6) +
  coord_cartesian(ylim=c(0,42))+
  facet_wrap(~Age_raw, scales="free_x", labeller = as_labeller(labs))+
  stat_compare_means(comparisons = my_comparisons,label="p.signif",
                     method = "wilcox.test",label.y = 38, hide.ns = TRUE) +
  theme(axis.title = element_text(size = 8), 
        axis.text = element_text(size = 8, family = "Arial"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position = "top",
        legend.title=element_text(size=8),
        legend.text = element_text(size =8),
        strip.text.x = element_text(size = 8),
        strip.text.y = element_text(size = 8),
        plot.title = element_text(size = 8,face="bold",hjust = 0.5,))+
  scale_color_manual(name= "Time",values = c("dodgerblue3","orange2")) + 
  labs(title ="Pseudotime distal from immature \nto mature B cells", x = c(color =''), y = 'Pseudotime') 

SF4_5
```

From Hscs to Pre/pro
```{r sf46,fig.height=3,fig.width=8/2}

my_comparisons <- list(c("2days", "5days"))

SF4_6<- sub[[]] %>%
  subset(compartments == "Dist") %>%
  filter(CellType %in% c("HPCs","Pre / Pro B Cells" )) %>% 
  select(sample,Age_raw,pseudotime_lin1,compartments,CellType,timepoint) %>% 
  mutate(Age_raw=factor(Age_raw, levels = c("Young", "Aged","ImmunoAged"))) %>%
  ggplot(aes(timepoint, pseudotime_lin1))+ 
  geom_boxplot(size = .4, outlier.size = 0) + 
  geom_point(aes(color = timepoint), position=position_jitterdodge(jitter.width = .2), shape = 1,size = .6) +
  coord_cartesian(ylim=c(0,40))+
  facet_wrap(~Age_raw, scales="free_x",labeller=as_labeller(labs))+
  stat_compare_means(comparisons = my_comparisons,label="p.signif",
                     method = "wilcox.test",label.y = 35, label.x = "5days" , hide.ns = TRUE) +
  theme(axis.title = element_text(size = 8), 
        axis.text = element_text(size = 8, family = "Arial"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position="top",
        legend.title=element_text(size=8),
        legend.text = element_text(size =8),
        strip.text.x = element_text(size = 8),
        strip.text.y = element_text(size = 8),
        plot.title = element_text(size = 8,face="bold",hjust = 0.5,))+
  scale_color_manual(name= "Time",values = c("dodgerblue3","orange2")) + 
  labs(title ="Pseudotime distal from HSCS \nto Pre / Pro B cells", x = c(color =''), y = 'Pseudotime') 

SF4_6
```

From Pre/pro B cells to immature B cells
```{r sf47,fig.height=3,fig.width=8/2}

my_comparisons <- list(c("2days", "5days"))

SF4_7<- sub[[]] %>%
  subset(compartments == "Dist") %>%
  filter(CellType %in% c("Pre / Pro B Cells","Immature B Cells")) %>% 
  select(sample,Age_raw,pseudotime_lin1,compartments,CellType,timepoint) %>% 
  mutate(Age_raw=factor(Age_raw, levels = c("Young", "Aged","ImmunoAged"))) %>%
  ggplot(aes(timepoint, pseudotime_lin1))+ 
  geom_boxplot(size = .4, outlier.size = 0) + 
  geom_point(aes(color = timepoint), position=position_jitterdodge(jitter.width = .2), shape = 1,size = .6) +
  coord_cartesian(ylim=c(0,40))+
  facet_wrap(~Age_raw, scales="free_x", labeller=as_labeller(labs))+
  stat_compare_means(comparisons = my_comparisons,label="p.signif",
                     method = "wilcox.test",label.y = 35, label.x = "5days" , hide.ns = TRUE,) +
  theme(axis.title = element_text(size = 8), 
        axis.text = element_text(size = 8, family = "Arial"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        #strip.background = element_blank(),
        legend.position="top",
        legend.title = element_text(size=8),
        legend.text = element_text(size =8),
        strip.text.x = element_text(size = 8),
        strip.text.y = element_text(size = 8),
        plot.title = element_text(size = 8,face="bold",hjust = 0.5,))+
  scale_color_manual(name= "Time",values = c("dodgerblue3","orange2")) + 
  labs(title ="Pseudotime distal from Pre / Pro B cells \nto immature B cells", x = c(color =''), y = 'Pseudotime') 

SF4_7

```

From immature B cells to mature B cells
```{r sf48,fig.height=3,fig.width=8/2}
my_comparisons <- list(c("2days", "5days"))


SF4_8<- sub[[]] %>%
  subset(compartments == "Dist") %>%
  filter(CellType %in% c("Immature B Cells","Mature B Cells")) %>% 
  select(sample,Age_raw,pseudotime_lin1,compartments,CellType,timepoint) %>% 
  mutate(Age_raw=factor(Age_raw, levels = c("Young", "Aged","ImmunoAged"))) %>%
  ggplot(aes(timepoint, pseudotime_lin1))+ 
  geom_boxplot(size = .4, outlier.size = 0) + 
  geom_point(aes(color = timepoint), position=position_jitterdodge(jitter.width = .2), shape = 1,size = .6) +
  coord_cartesian(ylim=c(0,42))+
  facet_wrap(~Age_raw, scales="free_x", labeller = as_labeller(labs))+
  stat_compare_means(comparisons = my_comparisons,label="p.signif",
                     method = "wilcox.test",label.y = 38, hide.ns = TRUE) +
  theme(axis.title = element_text(size = 8), 
        axis.text = element_text(size = 8, family = "Arial"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position = "top",
        legend.title=element_text(size=8),
        legend.text = element_text(size =8),
        strip.text.x = element_text(size = 8),
        strip.text.y = element_text(size = 8),
        plot.title = element_text(size = 8,face="bold",hjust = 0.5,))+
  scale_color_manual(name= "Time",values = c("dodgerblue3","orange2")) + 
  labs(title ="Pseudotime distal from immature \nto mature B cells", x = c(color =''), y = 'Pseudotime') 

SF4_8
```


Supplement Figure 4
```{r SFig3, fig.width = 8, fig.height = 10}

(wrap_elements(SF4_1)  + wrap_elements(SF4_2)) /
  (wrap_elements(SF4_3) + wrap_elements(SF4_4) + wrap_elements(SF4_5) ) /
  (wrap_elements(SF4_6) + wrap_elements(SF4_7) + wrap_elements(SF4_8) ) +
  plot_annotation(tag_levels = 'A') &
  theme(plot.tag = element_text(size = 8, face = "bold",hjust = -.5, vjust = 0))


if (file.exists(file.path(figure_out_path,"SFig4.pdf"))){
  try(ggsave(file.path(figure_out_path,"SFig4.pdf"), device = cairo_pdf,width=8,height=9), silent=T)
  warning("file not written, please close file in the other application and rerun.")
} else {
  ggsave(file.path(figure_out_path,"SFig4.pdf"), device = cairo_pdf,width=8,height=9)
}

```

```{r sessionInfo}
sessionInfo()
```

