---
output: 
  html_document:
    df_print: paged
    code_folding: hide
params:
  title: "Analysis 310124"
  path_to_object: "sobj.source_name.forced.rds"
title: "`r params$title`"
---



```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, cache=FALSE, cache.lazy=FALSE, message=FALSE, warning=FALSE)

suppressPackageStartupMessages(library(Seurat))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(gtools))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(cowplot))
suppressPackageStartupMessages(library(rstatix))
suppressPackageStartupMessages(library(DESeq2))
suppressPackageStartupMessages(library(ggrepel))
suppressPackageStartupMessages(library(stringr))

options(future.globals.maxSize = 12 * 1024 * 1024^2)

```

For this Seurat analysis, we used the following parameters:

```{r print parameters}

pars <- as.data.frame(do.call("rbind", params))
colnames(pars) <- "parameters_used"
pars

```

Starting with this Seurat object from SCBA output (integrated on source name).

```{r read_object, fig.height=4, fig.width=7}

path <- "/fast/groups/cubi/work/milekm/mireille/de/rerun/sc-batch-analysis-rerun/out_rds"
sobj <- readRDS(file.path(path,params$path_to_object))

DimPlot(sobj, label=T, repel =T)

```

Look at some quality control parameters.

```{r quality, fig.height=6, fig.width=8}

DefaultAssay(sobj) <- "RNA"

FeaturePlot(sobj, features = c("pct.mito", "pct.ribo", "Malat1", "Neat1"))

```

Show % cells per cluster per replicate to get an idea of reproducibility.

```{r cluster stats, fig.width=20,fig.height=25}

clusters <- sobj[[]] %>% 
  pull(seurat_clusters) %>% 
  unique() %>% as.character() %>% 
  as.numeric() %>% 
  sort() %>% 
  as.character()

sobj[[]] %>%
  select(sample, group, seurat_clusters,age,strain,compartment,timepoint) %>%
  group_by(sample, group, seurat_clusters,age,strain,compartment,timepoint) %>%
  summarise(ncells=n()) %>%
  ungroup() %>%
  group_by(sample) %>%
  mutate(cells_in_sample=sum(ncells), cell_proportion=ncells/sum(ncells)*100) %>%
  mutate(seurat_clusters = factor(seurat_clusters, levels = clusters)) %>%
  ggplot(aes(seurat_clusters, cell_proportion, fill=timepoint)) + 
  geom_boxplot(position=position_dodge(width=.5),width=.5, outlier.shape = 1, outlier.colour = "red")+
  geom_point(position=position_dodge(width=.5),colour='grey30', shape=1, size=2)+
   facet_wrap(~age+strain+compartment, scales = "free", ncol = 1) +
  theme(axis.text.x = element_text(angle=45,vjust=1,hjust=1))+
  xlab("")+ylab("% cells_in_sample")


```

Which proteins were detected in the ADT assay?

```{r adt}  
# which proteins are detected in ADT?
GetAssayData(sobj, assay = "Antibody.Capture", slot = "data") %>% rownames()

```


Possible outliers according to cell proportion analysis: 12w_nonSPF_5days_fx, 26w_nonSPF_5days_fx, 26w SPF 5days fx

Show RNA and ADT signal for the detected molecules.

```{r normalize adt}

DefaultAssay(sobj) <- "Antibody.Capture"

sobj <- sobj %>%
  NormalizeData(normalization.method = "CLR", margin = 2, assay = "Antibody.Capture")

DefaultAssay(sobj) <- "Antibody.Capture"

sobj %>%
  FeaturePlot(features=c("CD19"))

DefaultAssay(sobj) <- "RNA"
sobj %>%
  FeaturePlot(features=c("Cd19"))

DefaultAssay(sobj) <- "RNA"
sobj %>%
  FeaturePlot(features=c("Foxp3"))

sobj %>%
  FeaturePlot(features=c("Cd3e"))

DefaultAssay(sobj) <- "Antibody.Capture"
sobj %>%
  FeaturePlot(features=c("CD3"))

sobj %>%
  FeaturePlot(features=c("CD4"))

sobj %>%
  FeaturePlot(features=c("CD335"))
  

```  
  

Show dotplot for gene expression in clusters. 
```{r dotplots,fig.width=12, fig.height=7}

marks <- c("Siglech","S100a8","Csf1r","Cd3g","Klrd1","Cd79a","Vpreb1","Ebf1","Cd74","Ptprc","Tfrc","Hbb-bt","Kit","Flt3","Gata1"," Itga2b","Mpo","Elane","Ms4a2","Cd4","Cd8a","Cd19","Cd34","Cd27","Itga4","Itgax","Siglecf","Ccr3","Ly96","Chit1","Ctsk","Nfatc1","Atp6v0d2","Acp5","Ocstamp","Cd14", "Cxcr4", "Cx3cr1", "Ccr2","Mt3","Mmp9","Vcam1","C1qa","Cd5l","C1qc","Pf4")

Idents(sobj) <- "seurat_clusters"
DotPlot(sobj, assay = "RNA", features = marks) +
  theme(axis.text.x = element_text(angle=90,hjust=1,vjust=.5))

```


Show de novo markers per cluster (RNA assay).
```{r markers_denovo, fig.width=18, fig.height=8, results = F}

DefaultAssay(sobj) <- "RNA"
Idents(sobj) <- "seurat_clusters"

markers <- FindAllMarkers(sobj, only.pos = TRUE, min.pct = 0.25,
                          thresh.use = 0.25,
                          print.bar=FALSE, verbose=FALSE)

write.csv(markers,'310124_cluster_markers_rna.csv',row.names=FALSE)
markers <- read.csv('310124_cluster_markers_rna.csv',
                    stringsAsFactors=FALSE)

top5 <- markers %>%
  group_by(cluster) %>%
  top_n(5, avg_log2FC)

top10 <- markers %>%
  group_by(cluster) %>%
  top_n(10, avg_log2FC)

DotPlot(sobj, features = unique(top5$gene)) +
  theme_classic() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=.5))+
  ggtitle("top5 markers per cluster")

```


Show de novo markers for the ADT assay.
```{r markers_denovo_adt, fig.width=10, fig.height=8, results = F}

DefaultAssay(sobj) <- "Antibody.Capture"
Idents(sobj) <- "seurat_clusters"

markers <- FindAllMarkers(sobj, only.pos = TRUE, min.pct = 0.25,
                          thresh.use = 0.25,
                          print.bar=FALSE, verbose=FALSE)

write.csv(markers,'310124_cluster_markers_adt.csv',row.names=FALSE)
markers <- read.csv('310124_cluster_markers_adt.csv',
                    stringsAsFactors=FALSE)

top5 <- markers %>%
  group_by(cluster) %>%
  top_n(5, avg_log2FC)

top10 <- markers %>%
  group_by(cluster) %>%
  top_n(10, avg_log2FC)

DotPlot(sobj, features = unique(top5$gene)) +
  theme_classic() +
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=.5))+
  ggtitle("top5 markers per cluster")

```

Perform label transfer from the Tabula Muris, droplet dataset (FACS does not work for the label transfer here.)

```{r annotate,fig.height=5,fig.width=9}
DefaultAssay(sobj) <- "RNA"
#this is from tabula muris https://figshare.com/articles/dataset/Robject_files_for_tissues_processed_by_Seurat/5821263

load("references_bone_marrow/droplet_Marrow_seurat_tiss.Robj")
ref1 <- UpdateSeuratObject(tiss)

# load("references_bone_marrow/facs_Marrow_seurat_tiss.Robj")
# ref2<-UpdateSeuratObject(tiss)

anchors <- FindTransferAnchors(reference = ref1, query = sobj, dims = 1:20, reference.reduction = "pca")
predictions <- TransferData(anchorset = anchors, refdata = ref1$cell_ontology_class, dims = 1:20)
sobj <- AddMetaData(sobj, metadata = predictions)

# DimPlot(sobj, group.by="predicted.id")

DimPlot(sobj, group.by="predicted.id", label = T, repel = T)


```

Show distributions of label transfer scores. 
```{r score of label transfer, fig.width=12,fig.height=7}

cols <- colnames(sobj[[]])[grepl("predict", colnames(sobj[[]]))]

sobj[[]] %>%
  tibble::rownames_to_column("cells") %>%
    select(all_of(c("cells", cols))) %>%
  mutate(cell_id = paste0(cells, "_", predicted.id)) %>%
  select(-cells, -predicted.id) %>%
  pivot_longer(-cell_id, values_to = "score") %>%
  group_by(cell_id) %>%
  summarise(max_score = max(score)) %>%
  mutate(cell_type = sub(".*_", "", cell_id)) %>%
  ggplot(aes(cell_type, max_score, fill = cell_type)) + 
  geom_boxplot() +
  theme(axis.text.x=element_text(angle=90, hjust=1,vjust=.5))

```

Lets look at cell proportions again, this time by annotated cell type.

```{r proportions cell type, fig.width=10,fig.height=40}

sobj[[]] %>%
  select(sample, group, predicted.id,age,strain,compartment,timepoint) %>%
  group_by(sample, group, predicted.id,age,strain,compartment,timepoint) %>%
  summarise(ncells=n()) %>%
  ungroup() %>%
  group_by(sample) %>%
  mutate(cells_in_sample=sum(ncells), cell_proportion=ncells/sum(ncells)*100) %>%
  ggplot(aes(predicted.id, cell_proportion, fill=timepoint)) + 
  geom_boxplot(position=position_dodge(width=.5),width=.5, outlier.shape = 1, outlier.colour = "red")+
  geom_point(position=position_dodge(width=.5),colour='grey30', shape=1, size=2)+
   facet_wrap(~age+strain+compartment, scales = "free", ncol = 1) +
  theme(axis.text.x = element_text(angle=45,vjust=1,hjust=1))+
  xlab("")+ylab("% cells_in_sample")

```

Another dotplot of the cell markers after cell annotation.
```{r redo dotplot,fig.height=8,fig.width=16}

Idents(sobj) <- "predicted.id"
DotPlot(sobj, assay = "RNA", features = marks) +
  theme(axis.text.x = element_text(angle=90,hjust=1,vjust=.5))
```

Test for significant differences in cell proportions. 

```{r t test stats}

samples <- sobj[[]] %>% 
  pull(sample) %>% 
  unique()

cell_types <- sobj[[]] %>% 
  pull(predicted.id) %>% 
  unique()

sample_id <- expand_grid(samples, cell_types) %>%
  mutate(sample_id = paste0(samples,";", cell_types)) %>%
  select(-samples, -cell_types)

ncells <- sobj[[]] %>%
  select(sample, predicted.id) %>%
  group_by(sample, predicted.id,.drop = FALSE) %>%
  summarise(ncells=n()) %>%
  ungroup() %>%
  mutate(sample_id=paste0(sample,";",predicted.id)) %>%
  select(-sample, -predicted.id)

tot_cells <- sobj[[]] %>%
  select(sample) %>%
  group_by(sample,.drop = FALSE) %>%
  summarise(tot_cells=n()) %>%
  ungroup() 

df <- sample_id %>%
  left_join(ncells) %>%
  mutate(ncells=ifelse(is.na(ncells), 0, ncells)) %>%
  mutate(sample = sub(";.*", "", sample_id)) %>%
  left_join(tot_cells) %>%
  mutate(group=sub(".*-","",sub("_","-",sub("_","-",sub(";.*","",sample_id))))) %>%
  mutate(predicted.id=sub(".*;", "", sample_id)) %>%
  mutate(cell_proportion=ncells/tot_cells*100) %>%
  mutate(age=sub("_.*","",group)) %>%
  mutate(strain=sub("_.*","",sub(".*;", "", sub("_",";", group)))) %>%
  mutate(compartment=sub(".*_", "", group)) %>%
  mutate(timepoint=sub("_.*", "",sub(".*;", "",sub("_", ";",sub("_", ";", group))))) %>%
  mutate(group_cell_type=paste0(group,";",predicted.id))

day5 <- df %>%
  filter(timepoint=="5days") %>%
pull(group_cell_type) %>% unique()

day2 <- df %>%
  filter(timepoint=="2days") %>%
pull(group_cell_type) %>% unique()

comparisons_paired <- Map(c, day5,day2)
names(comparisons_paired) <- NULL

res_ttest <- df %>% 
  pairwise_t_test(cell_proportion~group_cell_type, comparisons=comparisons_paired, paired = T, p.adjust.method = "BH") %>%
  mutate(condition1=sub(";.*","", group1),
         condition2=sub(";.*","", group2),
         cell_type=sub(".*;","",group1)) %>%
  select(-group1,-group2)

DT::datatable(res_ttest,rownames=FALSE, extensions = 'Buttons', options = list(dom='frtBip', buttons = c('csv')))


# res_ttest_unpaired <- df %>%
#   split(f=.$predicted.id) %>%
#   lapply(function(x) x %>% 
#   pairwise_t_test(cell_proportion~group, p.adjust.method = "BH", paired=F)) %>%
#   bind_rows(.id="cell_type")
# 
# DT::datatable(res_ttest,rownames=FALSE, extensions = 'Buttons', options = list(dom='frtBip', buttons = c('csv')))


  
```

```{r cell proportions again, fig.height=4,fig.width=10, results=F}

# cell_type <- "immature B cell"
# 
# df %>%
#   filter(predicted.id== cell_type) %>%
#   mutate(age_strain=paste0(age,"_", strain)) %>%
#   mutate(compartment=factor(compartment, levels=c("fx", "proximal", "distal"))) %>%
#   ggplot(aes(age_strain, cell_proportion, fill=timepoint)) + 
#   geom_boxplot(position=position_dodge(width=.5),width=.5, outlier.shape = 1, outlier.colour = "red")+
#   geom_point(position=position_dodge(width=.5),colour='grey30', shape=1, size=2)+
#   facet_wrap(~compartment, scales = "free_x")+
#   scale_fill_manual(values=c("dodgerblue3", "orange2"))+
#   theme(axis.text.x = element_text(angle=45,vjust=1,hjust=1))+
#   xlab("")+ylab("% cells_in_sample")+
#   ggtitle(cell_type)

plot_proportions <- function(cell_type){
  df %>%
    filter(predicted.id== cell_type) %>%
    mutate(age_strain=paste0(age,"_", strain)) %>%
    mutate(compartment=factor(compartment, levels=c("fx", "proximal", "distal"))) %>%
    ggplot(aes(age_strain, cell_proportion, fill=timepoint)) + 
    geom_boxplot(position=position_dodge(width=.5),width=.5, outlier.shape = 1, outlier.colour = "red")+
    geom_point(position=position_dodge(width=.5),colour='grey30', shape=1, size=2)+
    facet_wrap(~compartment, scales = "free_x")+
    scale_fill_manual(values=c("dodgerblue3", "orange2"))+
    theme(axis.text.x = element_text(angle=45,vjust=1,hjust=1))+
    xlab("")+ylab("% cells_in_sample")+
    ggtitle(cell_type)
}


lapply(unique(df$predicted.id), plot_proportions)

```


```{r save rds}

saveRDS(sobj, "sobj.annotated.310124.rerun.rds")
```

```{r session}

sessionInfo()

```


